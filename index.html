<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TopScrolling - Firebase Single File</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f6f8;margin:0;color:#111}
    .header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.06);position:sticky;top:0;z-index:10}
    .logo{color:#e91e63;font-weight:700;font-size:20px}
    .container{max-width:900px;margin:18px auto;padding:0 12px}
    .card{background:#fff;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,0.06);padding:12px;margin-bottom:16px}
    .stories{display:flex;gap:12px;padding:12px 0;overflow-x:auto}
    .story{min-width:64px;text-align:center}
    .story img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid #e91e63}
    .post img.main{width:100%;height:420px;object-fit:cover;border-radius:6px}
    .row{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.primary{background:#e91e63;color:#fff}
    .input{padding:8px;border-radius:8px;border:1px solid #ddd;flex:1}
    .small{font-size:13px;color:#666}
    .like{cursor:pointer;font-weight:600}
    .comment-input{display:flex;gap:8px;margin-top:8px}
    .comment-input input{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
    .center{text-align:center;color:#777}
    .footer{padding:20px;text-align:center;color:#999}
    /* responsive */
    @media (max-width:600px){ .post img.main{height:320px} .container{padding:0 8px} }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">TopScrolling</div>
    <div class="small">Firebase demo ‚Äî replace config with yours</div>
  </header>

  <div class="container">
    <!-- Status / user area -->
    <div id="userCard" class="card">
      <div id="authSection">
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <button id="btnLogin" class="btn">Login</button>
          <button id="btnSignup" class="btn">Signup</button>
        </div>
        <div id="authForm" style="display:flex;gap:8px;align-items:center;">
          <input id="email" class="input" placeholder="Email" />
          <input id="password" class="input" placeholder="Password" type="password" />
          <button id="authSubmit" class="btn primary">Go</button>
        </div>
        <div id="authMsg" class="small" style="margin-top:8px;color:#666"></div>
      </div>

      <div id="userInfo" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div><strong id="userEmail"></strong></div>
            <div class="small">UID: <span id="userUid"></span></div>
          </div>
          <div>
            <button id="btnSignOut" class="btn">Sign out</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Create post -->
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">Create post</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="fileInput" type="file" accept="image/*" />
        <input id="captionInput" class="input" placeholder="Caption (optional)" />
        <button id="postBtn" class="btn primary">Post</button>
        <div id="uploadProgress" class="small" style="min-width:120px"></div>
      </div>
      <div class="small" style="margin-top:8px">Images stored in Firebase Storage. Posts saved to Firestore.</div>
    </div>

    <!-- Stories -->
    <div class="card stories" id="stories">
      <!-- filled by JS -->
    </div>

    <!-- Feed -->
    <div id="feedArea"></div>

    <div class="footer">Built with Firebase ‚Äî demo. Secure your rules before production.</div>
  </div>

  <!-- Firebase compat CDN (single-file demo uses compat libs for easy copy-paste) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
  /*************************************************************************
   * 1) REPLACE the firebaseConfig below with YOUR Firebase web app config
   *    (Firebase Console ‚Üí Project settings ‚Üí SDK setup & config)
   *
   * 2) In Firebase console:
   *    - Enable Authentication -> Email/Password
   *    - Create Firestore DB (start in test mode for dev)
   *    - Use Storage bucket (default)
   *
   * 3) This single file demo uses compat SDK for simplicity.
   *************************************************************************/
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // init
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // UI refs
  const btnLogin = document.getElementById('btnLogin');
  const btnSignup = document.getElementById('btnSignup');
  const authForm = document.getElementById('authForm');
  const authSubmit = document.getElementById('authSubmit');
  const authMsg = document.getElementById('authMsg');
  const emailInput = document.getElementById('email');
  const passInput = document.getElementById('password');
  const userInfo = document.getElementById('userInfo');
  const userCard = document.getElementById('userCard');
  const userEmailSpan = document.getElementById('userEmail');
  const userUidSpan = document.getElementById('userUid');
  const btnSignOut = document.getElementById('btnSignOut');

  const fileInput = document.getElementById('fileInput');
  const captionInput = document.getElementById('captionInput');
  const postBtn = document.getElementById('postBtn');
  const uploadProgress = document.getElementById('uploadProgress');

  const storiesEl = document.getElementById('stories');
  const feedArea = document.getElementById('feedArea');

  let authMode = 'login'; // or 'signup'
  btnLogin.onclick = ()=>{ authMode = 'login'; authMsg.textContent='Login mode'; }
  btnSignup.onclick = ()=>{ authMode = 'signup'; authMsg.textContent='Signup mode'; }

  authSubmit.onclick = async ()=>{
    const email = emailInput.value.trim();
    const pass = passInput.value;
    if(!email || !pass){ authMsg.textContent = 'Provide email & password'; return; }
    authMsg.textContent = 'Please wait...';
    try {
      if(authMode === 'signup'){
        await auth.createUserWithEmailAndPassword(email, pass);
        authMsg.textContent = 'Account created';
      } else {
        await auth.signInWithEmailAndPassword(email, pass);
        authMsg.textContent = 'Logged in';
      }
      emailInput.value = ''; passInput.value = '';
    } catch(e){
      authMsg.textContent = e.message || 'Error';
    }
  };

  btnSignOut.onclick = async ()=> {
    await auth.signOut();
  };

  // Auth state listener
  auth.onAuthStateChanged(user=>{
    if(user){
      // show user info
      authForm.style.display = 'none';
      authMsg.style.display = 'none';
      userInfo.style.display = 'block';
      userEmailSpan.textContent = user.email;
      userUidSpan.textContent = user.uid;
    } else {
      authForm.style.display = 'flex';
      authMsg.style.display = 'block';
      userInfo.style.display = 'none';
      authMsg.textContent = 'Not logged in';
    }
  });

  // sample stories
  const sampleStories = [
    {name:'yash', img:'https://source.unsplash.com/random/200x200?face'},
    {name:'aarav', img:'https://source.unsplash.com/random/200x200?person'},
    {name:'ria', img:'https://source.unsplash.com/random/200x200?girl'},
    {name:'travel', img:'https://source.unsplash.com/random/200x200?travel'},
    {name:'food', img:'https://source.unsplash.com/random/200x200?food'}
  ];
  sampleStories.forEach(s=>{
    const d = document.createElement('div'); d.className='story';
    d.innerHTML = `<img src="${s.img}" alt="${s.name}"/><div class="small">${s.name}</div>`;
    storiesEl.appendChild(d);
  });

  // Realtime posts listener
  function renderPosts(posts){
    feedArea.innerHTML = '';
    posts.forEach(p => {
      const div = document.createElement('div');
      div.className = 'card post';
      const created = p.createdAt && p.createdAt.toDate ? p.createdAt.toDate().toLocaleString() : '';
      const likesCount = Array.isArray(p.likes) ? p.likes.length : 0;
      const likedByMe = auth.currentUser && Array.isArray(p.likes) && p.likes.includes(auth.currentUser.uid);
      const commentsHtml = (Array.isArray(p.comments) && p.comments.slice(-5).map(c => `<div style="margin-top:6px"><strong>${escapeHtml(c.userEmail||'user')}</strong> <span class="small">${escapeHtml(c.text)}</span></div>`).join('')) || '';

      div.innerHTML = `
        <div class="post-header row" style="justify-content:space-between">
          <div class="row">
            <img src="https://www.gravatar.com/avatar/${(p.authorEmail||'').toLowerCase()}?d=identicon" style="width:40px;height:40px;border-radius:999px" />
            <div style="margin-left:8px">
              <div style="font-weight:700">${escapeHtml(p.authorEmail||'Unknown')}</div>
              <div class="small">${created}</div>
            </div>
          </div>
        </div>

        <div style="margin-top:10px"><img class="main" src="${p.imageURL}" alt="post" /></div>

        <div style="padding-top:8px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="row">
              <div class="like" data-id="${p.id}" style="font-size:20px">${likedByMe ? 'üíó' : 'ü§ç'}</div>
              <div style="margin-left:10px;font-weight:600">${likesCount} likes</div>
            </div>
            <div class="small">${escapeHtml(p.caption||'')}</div>
          </div>

          <div style="margin-top:8px">${commentsHtml}</div>

          <div class="comment-input">
            <input class="input comment-field" placeholder="Add a comment..." data-id="${p.id}" />
            <button class="btn comment-send" data-id="${p.id}">Send</button>
          </div>
        </div>
      `;
      feedArea.appendChild(div);
    });

    // attach like handlers
    Array.from(document.querySelectorAll('.like')).forEach(el=>{
      el.onclick = async ()=>{
        const postId = el.dataset.id;
        const user = auth.currentUser;
        if(!user){ alert('Login to like'); return; }
        const docRef = db.collection('posts').doc(postId);
        const docSnap = await docRef.get();
        if(!docSnap.exists){ return; }
        const data = docSnap.data();
        const has = Array.isArray(data.likes) && data.likes.includes(user.uid);
        if(has){
          await docRef.update({ likes: firebase.firestore.FieldValue.arrayRemove(user.uid) });
        } else {
          await docRef.update({ likes: firebase.firestore.FieldValue.arrayUnion(user.uid) });
        }
      };
    });

    // attach comment handlers
    Array.from(document.querySelectorAll('.comment-send')).forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        const input = document.querySelector('.comment-field[data-id="'+id+'"]');
        const text = input.value.trim();
        if(!text){ return; }
        const user = auth.currentUser;
        if(!user){ alert('Login to comment'); return; }
        const docRef = db.collection('posts').doc(id);
        await docRef.update({
          comments: firebase.firestore.FieldValue.arrayUnion({
            id: Date.now(),
            userId: user.uid,
            userEmail: user.email,
            text,
            createdAt: new Date().toISOString()
          })
        });
        input.value = '';
      };
    });
  }

  // snapshot listener
  db.collection('posts').orderBy('createdAt','desc').onSnapshot(snap=>{
    const arr = [];
    snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
    renderPosts(arr);
  });

  // post upload
  postBtn.onclick = async ()=>{
    const file = fileInput.files[0];
    const caption = captionInput.value.trim();
    const user = auth.currentUser;
    if(!user){ alert('Login to post'); return; }
    if(!file){ alert('Choose an image'); return; }
    const filePath = `posts/${user.uid}_${Date.now()}_${file.name.replace(/\s/g,'_')}`;
    const storageRef = storage.ref().child(filePath);
    const uploadTask = storageRef.put(file);
    uploadProgress.textContent = 'Uploading 0%';
    uploadTask.on('state_changed', snapshot=>{
      const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
      uploadProgress.textContent = 'Uploading ' + pct + '%';
    }, err=>{
      console.error(err); uploadProgress.textContent = 'Upload error';
    }, async ()=>{
      const url = await uploadTask.snapshot.ref.getDownloadURL();
      await db.collection('posts').add({
        authorId: user.uid,
        authorEmail: user.email,
        imageURL: url,
        caption: caption || '',
        likes: [],
        comments: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      uploadProgress.textContent = 'Posted';
      captionInput.value = ''; fileInput.value = '';
      setTimeout(()=>uploadProgress.textContent='',1200);
    });
  };

  // small helper to escape text for safe HTML injection
  function escapeHtml(str){
    if(!str) return '';
    return String(str).replace(/[&<>"'`]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[s]));
  }

  // initial sample data: if no posts exist, you can optionally create a sample post (commented out)
  // (uncomment to auto-create a sample post on first run)
  /*
  db.collection('posts').limit(1).get().then(snap=>{
    if(snap.empty){
      db.collection('posts').add({
        authorId: 'system',
        authorEmail: 'system@demo',
        imageURL: 'https://source.unsplash.com/random/900x600?nature',
        caption: 'Welcome to TopScrolling ‚Äî demo post',
        likes: [],
        comments: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  });
  */

  // done
  </script>
</body>
</html>
